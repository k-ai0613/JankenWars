From ae26983661546adfdc884377c0bfdac45d1dc95a Mon Sep 17 00:00:00 2001
From: k-ai0613 <kota.ynwa@gmail.com>
Date: Fri, 5 Dec 2025 17:29:39 +0900
Subject: [PATCH] Add security improvements, ads support, and Render deployment
 config
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- Add security headers (CSP, XSS protection, CORS restrictions)
- Add input validation and rate limiting for Socket.io
- Add Google AdSense ad components (AdBanner, InterstitialAd)
- Add useAds hook for ad management
- Add Render deployment configuration (render.yaml)
- Add Vercel SPA routing configuration (vercel.json)
- Fix TypeScript build errors
- Update environment variable handling for production

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
---
 .env.example                                  |  29 +++
 .gitignore                                    |   4 +-
 client/index.html                             |   6 +-
 client/src/components/ads/AdBanner.tsx        | 106 +++++++++
 client/src/components/ads/InterstitialAd.tsx  | 177 +++++++++++++++
 client/src/components/ads/index.ts            |   3 +
 .../components/game/SpecialPieceButton.tsx    |  44 ----
 client/src/components/ui/interface.tsx        |  95 --------
 client/src/hooks/useAds.ts                    | 102 +++++++++
 client/src/lib/socketService.ts               |  12 +-
 client/src/lib/stores/useJankenGame.fixed.ts  | 214 ------------------
 client/src/pages/GamePage.tsx                 |  22 +-
 client/src/pages/home.tsx                     |  11 +
 render.yaml                                   |  14 ++
 server/index.ts                               |  53 ++++-
 server/routes.ts                              | 198 ++++++++++++++--
 tsconfig.json                                 |   8 +-
 vercel.json                                   |  21 ++
 18 files changed, 734 insertions(+), 385 deletions(-)
 create mode 100644 .env.example
 create mode 100644 client/src/components/ads/AdBanner.tsx
 create mode 100644 client/src/components/ads/InterstitialAd.tsx
 create mode 100644 client/src/components/ads/index.ts
 delete mode 100644 client/src/components/game/SpecialPieceButton.tsx
 delete mode 100644 client/src/components/ui/interface.tsx
 create mode 100644 client/src/hooks/useAds.ts
 delete mode 100644 client/src/lib/stores/useJankenGame.fixed.ts
 create mode 100644 render.yaml
 create mode 100644 vercel.json

diff --git a/.env.example b/.env.example
new file mode 100644
index 0000000..013784a
--- /dev/null
+++ b/.env.example
@@ -0,0 +1,29 @@
+# JankenWars ç’°å¢ƒå¤‰æ•°è¨­å®šä¾‹
+# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ .env ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„
+
+# ===== ã‚µãƒ¼ãƒãƒ¼è¨­å®š =====
+NODE_ENV=development
+PORT=5000
+
+# CORSè¨±å¯ã‚ªãƒªã‚¸ãƒ³ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
+# æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„
+ALLOWED_ORIGINS=http://localhost:5000,http://localhost:3000
+
+# ===== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆVITE_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹å¿…é ˆï¼‰ =====
+# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼URLï¼ˆRenderç­‰ã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰
+# Vercelã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãã ã•ã„
+VITE_SERVER_URL=https://janken-wars-api.onrender.com
+
+# ===== Google AdSense è¨­å®š =====
+# AdSense ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼IDï¼ˆca-pub-XXXXXXXXXXXXXXXXå½¢å¼ï¼‰
+VITE_ADSENSE_CLIENT=
+
+# ãƒãƒŠãƒ¼åºƒå‘Šã‚¹ãƒ­ãƒƒãƒˆID
+VITE_ADSENSE_SLOT=
+
+# ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã‚¹ãƒ­ãƒƒãƒˆID
+VITE_ADSENSE_INTERSTITIAL_SLOT=
+
+# ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š =====
+# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšå¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
+# SESSION_SECRET=your-super-secret-key-here
diff --git a/.gitignore b/.gitignore
index ef048fd..67e6d17 100644
--- a/.gitignore
+++ b/.gitignore
@@ -42,4 +42,6 @@ summary.txt
 # Android/Mobile
 android/
 app/
-public/
\ No newline at end of file
+public/
+.vercel
+.env*.local
diff --git a/client/index.html b/client/index.html
index 27796f5..466572b 100644
--- a/client/index.html
+++ b/client/index.html
@@ -1,5 +1,5 @@
 <!DOCTYPE html>
-<html lang="en">
+<html lang="ja">
   <head>
     <meta charset="UTF-8" />
     <link rel="icon" type="image/png" href="/icons/favicon.png" />
@@ -9,6 +9,10 @@
     <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
     <link rel="manifest" href="/manifest.json" />
     <title>JankenWars</title>
+
+    <!-- Google AdSense -->
+    <!-- æœ¬ç•ªç’°å¢ƒã§ã¯ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤ã—ã€ca-pub-XXXXXXXXXXXXXXXX ã‚’å®Ÿéš›ã®ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼IDã«ç½®ãæ›ãˆã¦ãã ã•ã„ -->
+    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script> -->
   </head>
   <body>
     <div id="root"></div>
diff --git a/client/src/components/ads/AdBanner.tsx b/client/src/components/ads/AdBanner.tsx
new file mode 100644
index 0000000..945e503
--- /dev/null
+++ b/client/src/components/ads/AdBanner.tsx
@@ -0,0 +1,106 @@
+import React, { useEffect, useRef } from 'react';
+
+// Google AdSense åºƒå‘ŠãƒãƒŠãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
+// ä½¿ç”¨å‰ã« index.html ã« AdSense ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„
+
+interface AdBannerProps {
+  // AdSense åºƒå‘Šãƒ¦ãƒ‹ãƒƒãƒˆIDï¼ˆpub-XXXXXXXXXXXXXXXXå½¢å¼ï¼‰
+  adClient?: string;
+  // åºƒå‘Šã‚¹ãƒ­ãƒƒãƒˆID
+  adSlot?: string;
+  // åºƒå‘Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: 'auto', 'horizontal', 'vertical', 'rectangle'
+  adFormat?: 'auto' | 'horizontal' | 'vertical' | 'rectangle';
+  // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åºƒå‘Šã‹ã©ã†ã‹
+  fullWidthResponsive?: boolean;
+  // åºƒå‘Šã®ä½ç½®: 'top', 'bottom', 'sidebar'
+  position?: 'top' | 'bottom' | 'sidebar';
+  // ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹
+  className?: string;
+}
+
+declare global {
+  interface Window {
+    adsbygoogle: any[];
+  }
+}
+
+export const AdBanner: React.FC<AdBannerProps> = ({
+  adClient = import.meta.env.VITE_ADSENSE_CLIENT || '',
+  adSlot = import.meta.env.VITE_ADSENSE_SLOT || '',
+  adFormat = 'auto',
+  fullWidthResponsive = true,
+  position = 'bottom',
+  className = '',
+}) => {
+  const adRef = useRef<HTMLModElement>(null);
+  const isAdLoaded = useRef(false);
+
+  useEffect(() => {
+    // é–‹ç™ºç’°å¢ƒã¾ãŸã¯ AdSense è¨­å®šãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
+    if (!adClient || !adSlot) {
+      console.log('[AdBanner] AdSense credentials not configured. Showing placeholder.');
+      return;
+    }
+
+    // æ—¢ã«åºƒå‘ŠãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
+    if (isAdLoaded.current) {
+      return;
+    }
+
+    try {
+      // AdSense ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
+      if (typeof window !== 'undefined' && window.adsbygoogle) {
+        window.adsbygoogle.push({});
+        isAdLoaded.current = true;
+      }
+    } catch (error) {
+      console.error('[AdBanner] Error loading ad:', error);
+    }
+
+    return () => {
+      isAdLoaded.current = false;
+    };
+  }, [adClient, adSlot]);
+
+  // ä½ç½®ã«å¿œã˜ãŸã‚¹ã‚¿ã‚¤ãƒ«
+  const positionStyles: Record<string, string> = {
+    top: 'w-full min-h-[90px] mb-4',
+    bottom: 'w-full min-h-[90px] mt-4',
+    sidebar: 'w-full min-h-[250px]',
+  };
+
+  // AdSense ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
+  if (!adClient || !adSlot) {
+    return (
+      <div
+        className={`flex items-center justify-center bg-gray-100 dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg ${positionStyles[position]} ${className}`}
+      >
+        <div className="text-center text-gray-500 dark:text-gray-400 p-4">
+          <p className="text-sm font-medium">åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹</p>
+          <p className="text-xs mt-1">
+            AdSense ã‚’è¨­å®šã™ã‚‹ã«ã¯ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„
+          </p>
+          <p className="text-xs mt-1 font-mono">
+            VITE_ADSENSE_CLIENT, VITE_ADSENSE_SLOT
+          </p>
+        </div>
+      </div>
+    );
+  }
+
+  return (
+    <div className={`ad-container ${positionStyles[position]} ${className}`}>
+      <ins
+        ref={adRef}
+        className="adsbygoogle"
+        style={{ display: 'block' }}
+        data-ad-client={adClient}
+        data-ad-slot={adSlot}
+        data-ad-format={adFormat}
+        data-full-width-responsive={fullWidthResponsive ? 'true' : 'false'}
+      />
+    </div>
+  );
+};
+
+export default AdBanner;
diff --git a/client/src/components/ads/InterstitialAd.tsx b/client/src/components/ads/InterstitialAd.tsx
new file mode 100644
index 0000000..a696fbe
--- /dev/null
+++ b/client/src/components/ads/InterstitialAd.tsx
@@ -0,0 +1,177 @@
+import React, { useEffect, useState, useCallback } from 'react';
+import { motion, AnimatePresence } from 'framer-motion';
+
+// ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
+// ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã‚„ã‚·ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹å…¨ç”»é¢åºƒå‘Š
+
+interface InterstitialAdProps {
+  // åºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹
+  isVisible: boolean;
+  // åºƒå‘Šã‚’é–‰ã˜ãŸã¨ãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
+  onClose: () => void;
+  // è‡ªå‹•ã§é–‰ã˜ã‚‹ã¾ã§ã®æ™‚é–“ï¼ˆç§’ï¼‰
+  autoCloseSeconds?: number;
+  // AdSense ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
+  adClient?: string;
+  // AdSense åºƒå‘Šã‚¹ãƒ­ãƒƒãƒˆID
+  adSlot?: string;
+}
+
+declare global {
+  interface Window {
+    adsbygoogle: any[];
+  }
+}
+
+export const InterstitialAd: React.FC<InterstitialAdProps> = ({
+  isVisible,
+  onClose,
+  autoCloseSeconds = 5,
+  adClient = import.meta.env.VITE_ADSENSE_CLIENT || '',
+  adSlot = import.meta.env.VITE_ADSENSE_INTERSTITIAL_SLOT || '',
+}) => {
+  const [countdown, setCountdown] = useState(autoCloseSeconds);
+  const [canClose, setCanClose] = useState(false);
+
+  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å‡¦ç†
+  useEffect(() => {
+    if (!isVisible) {
+      setCountdown(autoCloseSeconds);
+      setCanClose(false);
+      return;
+    }
+
+    const timer = setInterval(() => {
+      setCountdown((prev) => {
+        if (prev <= 1) {
+          setCanClose(true);
+          clearInterval(timer);
+          return 0;
+        }
+        return prev - 1;
+      });
+    }, 1000);
+
+    return () => clearInterval(timer);
+  }, [isVisible, autoCloseSeconds]);
+
+  // åºƒå‘Šã®ãƒ­ãƒ¼ãƒ‰
+  useEffect(() => {
+    if (!isVisible || !adClient || !adSlot) return;
+
+    try {
+      if (typeof window !== 'undefined' && window.adsbygoogle) {
+        window.adsbygoogle.push({});
+      }
+    } catch (error) {
+      console.error('[InterstitialAd] Error loading ad:', error);
+    }
+  }, [isVisible, adClient, adSlot]);
+
+  const handleClose = useCallback(() => {
+    if (canClose) {
+      onClose();
+    }
+  }, [canClose, onClose]);
+
+  // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
+  useEffect(() => {
+    const handleKeyDown = (e: KeyboardEvent) => {
+      if (e.key === 'Escape' && canClose) {
+        handleClose();
+      }
+    };
+
+    if (isVisible) {
+      document.addEventListener('keydown', handleKeyDown);
+    }
+
+    return () => {
+      document.removeEventListener('keydown', handleKeyDown);
+    };
+  }, [isVisible, canClose, handleClose]);
+
+  return (
+    <AnimatePresence>
+      {isVisible && (
+        <motion.div
+          initial={{ opacity: 0 }}
+          animate={{ opacity: 1 }}
+          exit={{ opacity: 0 }}
+          className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
+          onClick={handleClose}
+        >
+          <motion.div
+            initial={{ scale: 0.9, opacity: 0 }}
+            animate={{ scale: 1, opacity: 1 }}
+            exit={{ scale: 0.9, opacity: 0 }}
+            className="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden"
+            onClick={(e) => e.stopPropagation()}
+          >
+            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
+            <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
+              <span className="text-sm text-gray-500 dark:text-gray-400">
+                ã‚¹ãƒãƒ³ã‚µãƒ¼åºƒå‘Š
+              </span>
+              <button
+                onClick={handleClose}
+                disabled={!canClose}
+                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
+                  canClose
+                    ? 'bg-blue-500 hover:bg-blue-600 text-white cursor-pointer'
+                    : 'bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed'
+                }`}
+              >
+                {canClose ? 'é–‰ã˜ã‚‹' : `${countdown}ç§’å¾Œã«é–‰ã˜ã‚‹`}
+              </button>
+            </div>
+
+            {/* åºƒå‘Šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
+            <div className="p-4 min-h-[300px] flex items-center justify-center">
+              {adClient && adSlot ? (
+                <ins
+                  className="adsbygoogle"
+                  style={{ display: 'block', width: '100%', height: '280px' }}
+                  data-ad-client={adClient}
+                  data-ad-slot={adSlot}
+                  data-ad-format="rectangle"
+                />
+              ) : (
+                <div className="text-center text-gray-500 dark:text-gray-400 p-8">
+                  <div className="w-16 h-16 mx-auto mb-4 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
+                    <svg
+                      className="w-8 h-8"
+                      fill="none"
+                      stroke="currentColor"
+                      viewBox="0 0 24 24"
+                    >
+                      <path
+                        strokeLinecap="round"
+                        strokeLinejoin="round"
+                        strokeWidth={2}
+                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
+                      />
+                    </svg>
+                  </div>
+                  <p className="text-lg font-medium mb-2">åºƒå‘Šãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼</p>
+                  <p className="text-sm">
+                    æœ¬ç•ªç’°å¢ƒã§ã¯ AdSense åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™
+                  </p>
+                </div>
+              )}
+            </div>
+
+            {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
+            <div className="p-4 bg-gray-50 dark:bg-gray-900 text-center">
+              <p className="text-xs text-gray-400">
+                åºƒå‘Šã‚’ã‚µãƒãƒ¼ãƒˆã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™
+              </p>
+            </div>
+          </motion.div>
+        </motion.div>
+      )}
+    </AnimatePresence>
+  );
+};
+
+export default InterstitialAd;
diff --git a/client/src/components/ads/index.ts b/client/src/components/ads/index.ts
new file mode 100644
index 0000000..cfb78db
--- /dev/null
+++ b/client/src/components/ads/index.ts
@@ -0,0 +1,3 @@
+// åºƒå‘Šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
+export { AdBanner } from './AdBanner';
+export { InterstitialAd } from './InterstitialAd';
diff --git a/client/src/components/game/SpecialPieceButton.tsx b/client/src/components/game/SpecialPieceButton.tsx
deleted file mode 100644
index 0017dff..0000000
--- a/client/src/components/game/SpecialPieceButton.tsx
+++ /dev/null
@@ -1,44 +0,0 @@
-import React from 'react';
-import { Button } from '../ui/button';
-import { FaStar } from 'react-icons/fa';
-import { GamePhase, Player, PieceType } from '../../lib/types';
-import { useJankenGame } from '../../lib/stores/useJankenGame';
-
-interface SpecialPieceButtonProps {
-  disabled?: boolean;
-}
-
-const SpecialPieceButton: React.FC<SpecialPieceButtonProps> = ({ 
-  disabled = false 
-}) => {
-  const { 
-    selectSpecialPiece, 
-    currentPlayer, 
-    phase,
-    player1Inventory,
-    player2Inventory
-  } = useJankenGame();
-
-  const inventory = currentPlayer === Player.PLAYER1 
-    ? player1Inventory 
-    : player2Inventory;
-
-  const hasSpecialPiece = inventory[PieceType.SPECIAL] > 0;
-  const isGameActive = phase === GamePhase.SELECTING_CELL;
-  const isButtonDisabled = disabled || !hasSpecialPiece || !isGameActive;
-
-  return (
-    <Button 
-      variant="outline" 
-      size="sm"
-      className="flex items-center gap-2"
-      onClick={selectSpecialPiece}
-      disabled={isButtonDisabled}
-    >
-      <FaStar className="text-yellow-500" />
-      <span>Use Special Piece</span>
-    </Button>
-  );
-};
-
-export default SpecialPieceButton;
diff --git a/client/src/components/ui/interface.tsx b/client/src/components/ui/interface.tsx
deleted file mode 100644
index 225fac2..0000000
--- a/client/src/components/ui/interface.tsx
+++ /dev/null
@@ -1,95 +0,0 @@
-import { useEffect } from "react";
-import { useGame } from "@/lib/stores/useGame";
-import { useAudio } from "@/lib/stores/useAudio";
-import { Button } from "./button";
-import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "./card";
-import { Confetti } from "../game/Confetti";
-import { VolumeX, Volume2, RotateCw, Trophy } from "lucide-react";
-
-export function Interface() {
-  const restart = useGame((state) => state.restart);
-  const phase = useGame((state) => state.phase);
-  const { isMuted, toggleMute } = useAudio();
-
-  // Handle clicks on the interface in the ready phase to start the game
-  useEffect(() => {
-    if (phase === "ready") {
-      const handleClick = () => {
-        document.activeElement?.blur(); // Remove focus from any button
-        const event = new KeyboardEvent("keydown", { code: "Space" });
-        window.dispatchEvent(event);
-      };
-
-      window.addEventListener("click", handleClick);
-      return () => window.removeEventListener("click", handleClick);
-    }
-  }, [phase]);
-
-  return (
-    <>
-      <Confetti />
-      
-      {/* Top-right corner UI controls */}
-      <div className="fixed top-4 right-4 flex gap-2 z-10">
-        <Button
-          variant="outline"
-          size="icon"
-          onClick={toggleMute}
-          title={isMuted ? "Unmute" : "Mute"}
-        >
-          {isMuted ? <VolumeX size={18} /> : <Volume2 size={18} />}
-        </Button>
-        
-        <Button
-          variant="outline"
-          size="icon"
-          onClick={restart}
-          title="Restart Game"
-        >
-          <RotateCw size={18} />
-        </Button>
-      </div>
-      
-      {/* Game completion overlay */}
-      {phase === "ended" && (
-        <div className="fixed inset-0 flex items-center justify-center z-20 bg-black/30">
-          <Card className="w-full max-w-md mx-4 shadow-lg">
-            <CardHeader>
-              <CardTitle className="flex items-center justify-center gap-2">
-                <Trophy className="text-yellow-500" />
-                Level Complete!
-              </CardTitle>
-            </CardHeader>
-            
-            <CardContent>
-              <p className="text-center text-muted-foreground">
-                Congratulations! You successfully navigated the course.
-              </p>
-            </CardContent>
-            
-            <CardFooter className="flex justify-center">
-              <Button onClick={restart} className="w-full">
-                Play Again
-              </Button>
-            </CardFooter>
-          </Card>
-        </div>
-      )}
-      
-      {/* Instructions panel */}
-      <div className="fixed bottom-4 left-4 z-10">
-        <Card className="w-auto max-w-xs bg-background/80 backdrop-blur-sm">
-          <CardContent className="p-4">
-            <h3 className="font-medium mb-2">Controls:</h3>
-            <ul className="text-sm space-y-1 text-muted-foreground">
-              <li>WASD or Arrow Keys: Move the ball</li>
-              <li>Space: Jump</li>
-              <li>R: Restart game</li>
-              <li>M: Toggle sound</li>
-            </ul>
-          </CardContent>
-        </Card>
-      </div>
-    </>
-  );
-}
diff --git a/client/src/hooks/useAds.ts b/client/src/hooks/useAds.ts
new file mode 100644
index 0000000..176e70a
--- /dev/null
+++ b/client/src/hooks/useAds.ts
@@ -0,0 +1,102 @@
+import { useState, useCallback, useEffect } from 'react';
+
+// åºƒå‘Šè¡¨ç¤ºã®é »åº¦ç®¡ç†
+const AD_FREQUENCY = {
+  // ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹é–“éš”ï¼ˆã‚²ãƒ¼ãƒ æ•°ï¼‰
+  INTERSTITIAL_INTERVAL: 3,
+  // æœ€å¾Œã«åºƒå‘Šã‚’è¡¨ç¤ºã—ãŸæ™‚åˆ»ã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ¼
+  LAST_AD_KEY: 'janken_last_ad_time',
+  // åºƒå‘Šè¡¨ç¤ºã®æœ€å°é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
+  MIN_AD_INTERVAL: 60000, // 1åˆ†
+};
+
+interface UseAdsReturn {
+  // ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã®è¡¨ç¤ºçŠ¶æ…‹
+  showInterstitial: boolean;
+  // ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã‚’è¡¨ç¤º
+  triggerInterstitial: () => void;
+  // ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã‚’é–‰ã˜ã‚‹
+  closeInterstitial: () => void;
+  // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«å‘¼ã³å‡ºã™ï¼ˆåºƒå‘Šè¡¨ç¤ºåˆ¤å®šï¼‰
+  onGameEnd: () => void;
+  // åºƒå‘ŠãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
+  isAdsConfigured: boolean;
+}
+
+export const useAds = (): UseAdsReturn => {
+  const [showInterstitial, setShowInterstitial] = useState(false);
+  const [gameCount, setGameCount] = useState(0);
+
+  // AdSense ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
+  const isAdsConfigured = Boolean(
+    import.meta.env.VITE_ADSENSE_CLIENT &&
+    import.meta.env.VITE_ADSENSE_SLOT
+  );
+
+  // æœ€å¾Œã®åºƒå‘Šè¡¨ç¤ºã‹ã‚‰ã®çµŒéæ™‚é–“ã‚’ç¢ºèª
+  const canShowAd = useCallback((): boolean => {
+    const lastAdTime = localStorage.getItem(AD_FREQUENCY.LAST_AD_KEY);
+    if (!lastAdTime) return true;
+
+    const elapsed = Date.now() - parseInt(lastAdTime, 10);
+    return elapsed >= AD_FREQUENCY.MIN_AD_INTERVAL;
+  }, []);
+
+  // åºƒå‘Šè¡¨ç¤ºæ™‚åˆ»ã‚’è¨˜éŒ²
+  const recordAdShown = useCallback(() => {
+    localStorage.setItem(AD_FREQUENCY.LAST_AD_KEY, Date.now().toString());
+  }, []);
+
+  // ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã‚’è¡¨ç¤º
+  const triggerInterstitial = useCallback(() => {
+    if (!canShowAd()) {
+      console.log('[useAds] Ad shown too recently, skipping');
+      return;
+    }
+    setShowInterstitial(true);
+    recordAdShown();
+  }, [canShowAd, recordAdShown]);
+
+  // ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Šã‚’é–‰ã˜ã‚‹
+  const closeInterstitial = useCallback(() => {
+    setShowInterstitial(false);
+  }, []);
+
+  // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®å‡¦ç†
+  const onGameEnd = useCallback(() => {
+    setGameCount((prev) => {
+      const newCount = prev + 1;
+      // ä¸€å®šå›æ•°ã”ã¨ã«åºƒå‘Šã‚’è¡¨ç¤º
+      if (newCount >= AD_FREQUENCY.INTERSTITIAL_INTERVAL) {
+        setTimeout(() => {
+          triggerInterstitial();
+        }, 1500); // çµæœè¡¨ç¤ºå¾Œã«å°‘ã—é…å»¶
+        return 0; // ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
+      }
+      return newCount;
+    });
+  }, [triggerInterstitial]);
+
+  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚²ãƒ¼ãƒ ã‚«ã‚¦ãƒ³ãƒˆã‚’å¾©å…ƒ
+  useEffect(() => {
+    const savedCount = sessionStorage.getItem('janken_game_count');
+    if (savedCount) {
+      setGameCount(parseInt(savedCount, 10));
+    }
+  }, []);
+
+  // ã‚²ãƒ¼ãƒ ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¿å­˜
+  useEffect(() => {
+    sessionStorage.setItem('janken_game_count', gameCount.toString());
+  }, [gameCount]);
+
+  return {
+    showInterstitial,
+    triggerInterstitial,
+    closeInterstitial,
+    onGameEnd,
+    isAdsConfigured,
+  };
+};
+
+export default useAds;
diff --git a/client/src/lib/socketService.ts b/client/src/lib/socketService.ts
index c24be3b..15dc7ad 100644
--- a/client/src/lib/socketService.ts
+++ b/client/src/lib/socketService.ts
@@ -57,6 +57,7 @@ export interface GameState {
   gamePhase: GamePhase;
   gameResult: GameResult;
   lastMove?: { player: Player; piece: PieceType; position: Position } | null;
+  winningLine?: { positions: Position[]; player: Player } | null;
 }
 
 // â˜… è¿½åŠ : MoveDetails å‹ (ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹æ‰‹ã®è©³ç´°)
@@ -79,11 +80,18 @@ class SocketService {
       return;
     }
 
-    const serverUrl = 'http://localhost:5000'; // ã‚µãƒ¼ãƒãƒ¼ã®URLã‚’ç›´æ¥æŒ‡å®š
+    // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼URLã‚’å–å¾—ï¼ˆæœ¬ç•ªç’°å¢ƒå¯¾å¿œï¼‰
+    const serverUrl = import.meta.env.VITE_SERVER_URL ||
+                      (import.meta.env.PROD ? window.location.origin : 'http://localhost:5000');
 
     // Connect to the server
     this.socket = io(serverUrl, {
-      transports: ['websocket', 'polling']
+      transports: ['websocket', 'polling'],
+      withCredentials: true,
+      timeout: 20000,
+      reconnection: true,
+      reconnectionAttempts: 5,
+      reconnectionDelay: 1000
     });
 
     // Set up event listeners
diff --git a/client/src/lib/stores/useJankenGame.fixed.ts b/client/src/lib/stores/useJankenGame.fixed.ts
deleted file mode 100644
index a10c9c8..0000000
--- a/client/src/lib/stores/useJankenGame.fixed.ts
+++ /dev/null
@@ -1,214 +0,0 @@
-// ãƒ†ã‚¹ãƒˆç”¨ã®æ–°ã—ã„é–¢æ•°å®šç¾© - å¾Œã§ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆ
-
-// selectCellForPlayeré–¢æ•°ã®ä¿®æ­£ç‰ˆ - ãŠãƒ¼ãªãƒ¼æ–‡å­—åˆ—ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…
-
-export const selectCellForPlayer = (position: Position, player: Player | string, piece: PieceType) => {
-  const { 
-    board, 
-    player1Inventory, 
-    player2Inventory 
-  } = get();
-  
-  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤ã‚’æ–‡å­—åˆ—ã¨ã—ã¦ç›´æ¥æ‰±ã†
-  const playerString = String(player).toUpperCase();
-  console.log('ğŸ” DIRECT STRING selectCellForPlayer:', { 
-    position, 
-    originalPlayer: player, 
-    playerString, 
-    piece,
-    playerType: typeof player,
-    stringType: typeof playerString,
-    isPlayer2ByString: playerString === 'PLAYER2' || playerString.includes('PLAYER2')
-  });
-  
-  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èªè­˜ã‚’æ–‡å­—åˆ—ãƒ™ãƒ¼ã‚¹ã§è¡Œã†
-  const isPlayer1 = playerString === 'PLAYER1' || playerString.includes('PLAYER1');
-  const isPlayer2 = playerString === 'PLAYER2' || playerString.includes('PLAYER2');
-  
-  // Playerå‹ã¨ã—ã¦ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã®ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä¸Šã®é‚ªé­”ãªãŸã‚ã®ã¿
-  const playerForMove = isPlayer2 ? Player.PLAYER2 : (isPlayer1 ? Player.PLAYER1 : Player.NONE);
-  
-  // Check if move is valid - æ–‡å­—åˆ—èªè­˜çµæœã«åŸºã¥ãå€¤ã‚’ä½¿ç”¨
-  if (!isValidMove(board, position, piece, playerForMove)) {
-    console.warn('Invalid AI move');
-    set({ message: 'message.invalidMove', isAIThinking: false });
-    return;
-  }
-  
-  // Clone the board
-  const newBoard = [...board.map(row => [...row])];
-  
-  // Create a new inventory - æ–‡å­—åˆ—åˆ¤å®šã«åŸºã¥ã
-  const currentInventory = isPlayer1 
-    ? { ...player1Inventory }
-    : { ...player2Inventory };
-  
-  // Reduce the count of the selected piece
-  if (piece && piece !== PieceType.EMPTY && 
-      (piece === PieceType.ROCK || 
-       piece === PieceType.PAPER || 
-       piece === PieceType.SCISSORS || 
-       piece === PieceType.SPECIAL)) {
-    currentInventory[piece]--;
-  }
-  
-  // Update the cell
-  const targetCell = newBoard[position.row][position.col];
-  
-  // Play sound effect
-  const audioStore = useAudio.getState();
-  
-  // æ–‡å­—åˆ—ã«ã‚ˆã‚‹æ‰€æœ‰è€…åˆ¤å®šçµæœã‚’ä½¿ç”¨
-  console.log(`Using direct string player id: ${playerString} (original: ${player})`);
-  
-  // If the cell is empty
-  if (targetCell.piece === PieceType.EMPTY) {
-    // æ–‡å­—åˆ—åˆ¤å®šçµæœã‚’åŸºã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç‰¹å®š
-    let ownerString: string;
-    
-    // ç‰¹ã«é‡è¦ãªã®ã¯PLAYER2ã®ã‚±ãƒ¼ã‚¹ - æ–‡å­—åˆ—ã§åˆ¤æ–­
-    if (isPlayer2) {
-      ownerString = 'PLAYER2'; // å®Œå…¨ã«ç¢ºå®Ÿãªæ–‡å­—åˆ—
-      console.log('Direct PLAYER2 string assignment in cell update!');
-    } else if (isPlayer1) {
-      ownerString = 'PLAYER1'; // å®Œå…¨ã«ç¢ºå®Ÿãªæ–‡å­—åˆ—
-    } else {
-      ownerString = 'NONE'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
-    }
-    
-    // æ–°ã—ã„ã‚»ãƒ«ã‚’ä½œæˆ - æ˜ç¤ºçš„ã«æ–‡å­—åˆ—ã‚’ä½¿ç”¨
-    const newCell: Cell = {
-      piece: piece,
-      owner: ownerString as Player, // ã‚­ãƒ£ã‚¹ãƒˆã—ã¦å‹ã‚’åˆã‚ã›ã‚‹
-      hasBeenUsed: false // Not locked yet, can be captured with janken rules
-    };
-    
-    // é©åˆ‡ãªè‰²ãŒé©ç”¨ã•ã‚Œã‚‹ã‚ˆã†è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
-    console.log('ğŸ“¦ NEW CELL CREATION:', {
-      position,
-      originalPlayer: player,
-      playerString,
-      ownerString,
-      cell: newCell,
-      ownerType: typeof newCell.owner,
-      ownerValue: String(newCell.owner),
-      isPlayer2: ownerString === 'PLAYER2',
-      // Debug ID for tracking the update
-      updateId: Math.random().toString(36).substring(2, 9)
-    });
-    
-    // æ–°ã—ã„ã‚»ãƒ«ã‚’ãƒœãƒ¼ãƒ‰ã«é…ç½®
-    newBoard[position.row][position.col] = newCell;
-    
-    // Play success sound
-    audioStore.playSuccess();
-  } else {
-    // Janken battle - replace opponent's piece and lock this cell
-    const defendingPiece = targetCell.piece;
-    
-    // ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ãƒãƒˆãƒ«ã®å ´åˆã‚‚æ–‡å­—åˆ—ã‚’æ˜ç¤ºçš„ã«ä½¿ç”¨
-    let battleOwnerString: string;
-    
-    // æ–‡å­—åˆ—åˆ¤å®šçµæœã«åŸºã¥ã„ã¦ã‚ªãƒ¼ãƒŠãƒ¼ã‚’æ±ºå®š
-    if (isPlayer2) {
-      battleOwnerString = 'PLAYER2'; // å®Œå…¨ã«ç¢ºå®Ÿãªæ–‡å­—åˆ—
-      console.log('Direct PLAYER2 string in Janken battle!');
-    } else if (isPlayer1) {
-      battleOwnerString = 'PLAYER1'; // å®Œå…¨ã«ç¢ºå®Ÿãªæ–‡å­—åˆ—
-    } else {
-      battleOwnerString = 'NONE'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
-    }
-    
-    // æ–°ã—ã„ã‚»ãƒ«ã‚’ä½œæˆ - æ˜ç¤ºçš„ã«æ–‡å­—åˆ—ã‚’ä½¿ç”¨
-    const battleCell: Cell = {
-      piece: piece,
-      owner: battleOwnerString as Player, // ã‚­ãƒ£ã‚¹ãƒˆã—ã¦å‹ã‚’åˆã‚ã›ã‚‹
-      hasBeenUsed: true // Lock this cell after janken battle
-    };
-    
-    console.log('âš”ï¸ JANKEN_BATTLE_UPDATE:', {
-      position,
-      originalPlayer: player,
-      playerString,
-      battleOwnerString,
-      cell: battleCell,
-      ownerType: typeof battleCell.owner,
-      ownerValue: String(battleCell.owner),
-      isPlayer2: battleOwnerString === 'PLAYER2',
-      battleId: Math.random().toString(36).substring(2, 9)
-    });
-    
-    newBoard[position.row][position.col] = battleCell;
-    
-    // Play hit sound
-    audioStore.playHit();
-    
-    // Trigger capture animation
-    set({ captureAnimation: position });
-    
-    // Display a message about the janken battle result
-    let jankenResultMessage = '';
-    
-    // Create a specific message based on what pieces were involved
-    // In Japanese Janken Rules:
-    // - Rock (ã‚°ãƒ¼) beats Scissors (ãƒãƒ§ã‚­)
-    // - Scissors (ãƒãƒ§ã‚­) beats Paper (ãƒ‘ãƒ¼)
-    // - Paper (ãƒ‘ãƒ¼) beats Rock (ã‚°ãƒ¼)
-    if (piece === PieceType.ROCK && defendingPiece === PieceType.SCISSORS) {
-      jankenResultMessage = 'message.rockVsScissors';
-    } else if (piece === PieceType.SCISSORS && defendingPiece === PieceType.PAPER) {
-      jankenResultMessage = 'message.scissorsVsPaper';
-    } else if (piece === PieceType.PAPER && defendingPiece === PieceType.ROCK) {
-      jankenResultMessage = 'message.paperVsRock';
-    }
-    
-    // Set the message key for translation
-    set({ message: jankenResultMessage });
-  }
-  
-  // Update inventories
-  const newState = {
-    board: newBoard,
-    selectedPiece: null,
-    player2Inventory: currentInventory
-  };
-  
-  // Check for win condition
-  if (checkWin(newBoard, Player.PLAYER2)) {  // AI playerã®winæ¡ä»¶
-    // The AI won!
-    set({
-      ...newState,
-      result: GameResult.PLAYER2_WIN,
-      phase: GamePhase.GAME_OVER,
-      message: 'message.player2Win',
-      winAnimation: true
-    });
-    
-    return;
-  }
-  
-  // Check for draw condition
-  if (checkDraw(newBoard, player1Inventory, currentInventory)) {
-    set({
-      ...newState,
-      result: GameResult.DRAW,
-      phase: GamePhase.GAME_OVER,
-      message: 'message.draw',
-      drawAnimation: true
-    });
-    
-    return;
-  }
-  
-  // Switch player to Player 1
-  set({
-    ...newState,
-    currentPlayer: Player.PLAYER1,
-    message: 'message.player1Turn'
-  });
-  
-  // Get random piece for Player 1's next turn
-  setTimeout(() => {
-    get().getRandomPieceForCurrentPlayer();
-  }, 100);
-};
\ No newline at end of file
diff --git a/client/src/pages/GamePage.tsx b/client/src/pages/GamePage.tsx
index 58c500e..b98db12 100644
--- a/client/src/pages/GamePage.tsx
+++ b/client/src/pages/GamePage.tsx
@@ -14,6 +14,8 @@ import { motion } from 'framer-motion';
 import { useLanguage } from '../lib/stores/useLanguage';
 import { Switch } from "../components/ui/switch";
 import { Label } from "../components/ui/label";
+import { AdBanner, InterstitialAd } from '../components/ads';
+import { useAds } from '../hooks/useAds';
 
 // å…¬é–‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ - ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ©‹æ¸¡ã—
 function GamePage() {
@@ -30,7 +32,10 @@ function GamePage() {
 function ClientOnlyGamePage() {
   const navigate = useNavigate();
   const { t, language, setLanguage } = useLanguage();
-  
+
+  // åºƒå‘Šãƒ•ãƒƒã‚¯
+  const { showInterstitial, closeInterstitial, onGameEnd } = useAds();
+
   const {
     player1Inventory,
     player2Inventory,
@@ -49,6 +54,14 @@ function ClientOnlyGamePage() {
     placePiece,
   } = useJankenGame();
 
+  // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«åºƒå‘Šã‚’è¡¨ç¤º
+  React.useEffect(() => {
+    if (phase === GamePhase.GAME_OVER) {
+      // ã‚²ãƒ¼ãƒ çµæœè¡¨ç¤ºå¾Œã«åºƒå‘Šåˆ¤å®š
+      onGameEnd();
+    }
+  }, [phase, onGameEnd]);
+
   // AIãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹
   React.useEffect(() => {
     // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰AIãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
@@ -305,6 +318,13 @@ function ClientOnlyGamePage() {
 
   return (
     <ErrorBoundary key="game-page-error-boundary">
+      {/* ã‚¤ãƒ³ã‚¿ãƒ¼ã‚¹ãƒ†ã‚£ã‚·ãƒ£ãƒ«åºƒå‘Š */}
+      <InterstitialAd
+        isVisible={showInterstitial}
+        onClose={closeInterstitial}
+        autoCloseSeconds={5}
+      />
+
       <div className="flex flex-col h-full md:h-screen py-1 px-0.5 md:py-2 md:px-2">
         <div className="flex flex-col md:flex-row w-full h-full md:space-x-1">
           {/* å·¦å´ã®æƒ…å ±ãƒ‘ãƒãƒ« */}
diff --git a/client/src/pages/home.tsx b/client/src/pages/home.tsx
index b3591b6..877119a 100644
--- a/client/src/pages/home.tsx
+++ b/client/src/pages/home.tsx
@@ -8,6 +8,7 @@ import { FaHandRock, FaHandPaper, FaHandScissors, FaStar, FaBrain } from 'react-
 import { useLanguage } from '../lib/stores/useLanguage';
 import { Switch } from "../components/ui/switch";
 import { Label } from "../components/ui/label";
+import { AdBanner } from '../components/ads';
 
 // AIé›£æ˜“åº¦ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±ä¸€ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
 const difficultyButtonVariants = {
@@ -372,6 +373,16 @@ export function Home() {
               </div>
             </div>
           </motion.div>
+
+          {/* åºƒå‘ŠãƒãƒŠãƒ¼ */}
+          <motion.div
+            className="w-full max-w-2xl mx-auto mt-8"
+            initial={{ opacity: 0 }}
+            animate={{ opacity: 1 }}
+            transition={{ duration: 0.5, delay: 0.6 }}
+          >
+            <AdBanner position="bottom" />
+          </motion.div>
         </div>
       </div>
     </div>
diff --git a/render.yaml b/render.yaml
new file mode 100644
index 0000000..d1260f7
--- /dev/null
+++ b/render.yaml
@@ -0,0 +1,14 @@
+services:
+  - type: web
+    name: janken-wars-api
+    env: node
+    plan: free
+    buildCommand: npm install && npm run build
+    startCommand: npm run start
+    envVars:
+      - key: NODE_ENV
+        value: production
+      - key: PORT
+        value: 10000
+      - key: ALLOWED_ORIGINS
+        value: https://janken-wars.vercel.app,https://janken-wars-api.onrender.com
diff --git a/server/index.ts b/server/index.ts
index da2d962..503ac90 100644
--- a/server/index.ts
+++ b/server/index.ts
@@ -11,18 +11,55 @@ app.use(express.urlencoded({ extended: false, limit: '10mb' }));
 // Keep-Aliveè¨­å®šã§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³å®‰å®šåŒ–
 app.set('trust proxy', 1);
 
-// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
+// è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¤‰æ›´ï¼‰
+const ALLOWED_ORIGINS = process.env.ALLOWED_ORIGINS
+  ? process.env.ALLOWED_ORIGINS.split(',')
+  : ['http://localhost:5000', 'http://localhost:3000', 'http://127.0.0.1:5000'];
+
+// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
 app.use((req, res, next) => {
   // Keep-Aliveè¨­å®š
   res.setHeader('Connection', 'keep-alive');
   res.setHeader('Keep-Alive', 'timeout=30, max=1000');
-  
-  // CORSè¨­å®šã®æ”¹å–„
-  res.setHeader('Access-Control-Allow-Origin', '*');
+
+  // CORSè¨­å®šï¼ˆã‚ªãƒªã‚¸ãƒ³ã‚’åˆ¶é™ï¼‰
+  const origin = req.headers.origin;
+  if (origin && ALLOWED_ORIGINS.includes(origin)) {
+    res.setHeader('Access-Control-Allow-Origin', origin);
+  }
   res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
   res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
-  res.setHeader('Access-Control-Max-Age', '86400'); // 24æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
-  
+  res.setHeader('Access-Control-Allow-Credentials', 'true');
+  res.setHeader('Access-Control-Max-Age', '86400');
+
+  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
+  res.setHeader('X-Content-Type-Options', 'nosniff');
+  res.setHeader('X-Frame-Options', 'SAMEORIGIN');
+  res.setHeader('X-XSS-Protection', '1; mode=block');
+  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
+
+  // Content Security Policyï¼ˆåºƒå‘Šå¯¾å¿œï¼‰
+  res.setHeader('Content-Security-Policy',
+    "default-src 'self'; " +
+    "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://pagead2.googlesyndication.com https://www.googletagservices.com https://adservice.google.com; " +
+    "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; " +
+    "font-src 'self' https://fonts.gstatic.com; " +
+    "img-src 'self' data: https: blob:; " +
+    "connect-src 'self' ws: wss: https://pagead2.googlesyndication.com; " +
+    "frame-src 'self' https://googleads.g.doubleclick.net https://www.google.com https://tpc.googlesyndication.com;"
+  );
+
+  // HTTPSå¼·åˆ¶ï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
+  if (process.env.NODE_ENV === 'production') {
+    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
+  }
+
+  // OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®å¯¾å¿œ
+  if (req.method === 'OPTIONS') {
+    res.status(204).end();
+    return;
+  }
+
   next();
 });
 
@@ -76,8 +113,8 @@ app.use((req, res, next) => {
     serveStatic(app);
   }
 
-  // ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒ¼ãƒˆ5000ã§èµ·å‹•
-  const port = 5000;
+  // ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒ¼ãƒˆã§èµ·å‹•ï¼ˆç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5000ï¼‰
+  const port = parseInt(process.env.PORT || '5000', 10);
   
   // ã‚µãƒ¼ãƒãƒ¼è¨­å®šã®æ”¹å–„
   server.timeout = 30000; // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
diff --git a/server/routes.ts b/server/routes.ts
index a6b2ded..02fbf64 100644
--- a/server/routes.ts
+++ b/server/routes.ts
@@ -24,6 +24,90 @@ import {
   findWinningLine,
 } from "../client/src/lib/gameUtils";
 
+// ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•° =====
+
+// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
+function validateUsername(username: unknown): string {
+  if (typeof username !== 'string') {
+    return 'Anonymous';
+  }
+  // XSSå¯¾ç­–: HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã€é•·ã•ã‚’åˆ¶é™
+  const sanitized = username
+    .replace(/<[^>]*>/g, '')
+    .replace(/[<>\"'&]/g, '')
+    .trim()
+    .substring(0, 20);
+  return sanitized || 'Anonymous';
+}
+
+// ãƒ«ãƒ¼ãƒ IDã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
+function validateRoomId(roomId: unknown): string | null {
+  if (typeof roomId !== 'string') {
+    return null;
+  }
+  // ãƒ«ãƒ¼ãƒ IDã¯8æ–‡å­—ã®è‹±æ•°å­—ã®ã¿è¨±å¯
+  const sanitized = roomId.replace(/[^a-zA-Z0-9-]/g, '').substring(0, 8);
+  return sanitized.length >= 6 ? sanitized : null;
+}
+
+// Position ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
+function validatePosition(position: unknown): Position | null {
+  if (!position || typeof position !== 'object') {
+    return null;
+  }
+  const pos = position as { row?: unknown; col?: unknown };
+  if (typeof pos.row !== 'number' || typeof pos.col !== 'number') {
+    return null;
+  }
+  if (pos.row < 0 || pos.row > 5 || pos.col < 0 || pos.col > 5) {
+    return null;
+  }
+  return { row: pos.row, col: pos.col };
+}
+
+// PieceType ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
+function validatePieceType(piece: unknown): PieceType | null {
+  const validPieces = [PieceType.ROCK, PieceType.PAPER, PieceType.SCISSORS, PieceType.SPECIAL];
+  if (typeof piece === 'string' && validPieces.includes(piece as PieceType)) {
+    return piece as PieceType;
+  }
+  return null;
+}
+
+// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ã®ãƒˆãƒ©ãƒƒã‚«ãƒ¼
+const rateLimitTracker: Map<string, { count: number; resetTime: number }> = new Map();
+const RATE_LIMIT_MAX = 100; // 1åˆ†ã‚ãŸã‚Šã®æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
+const RATE_LIMIT_WINDOW = 60000; // 1åˆ†
+
+function checkRateLimit(socketId: string): boolean {
+  const now = Date.now();
+  const tracker = rateLimitTracker.get(socketId);
+
+  if (!tracker || now > tracker.resetTime) {
+    rateLimitTracker.set(socketId, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });
+    return true;
+  }
+
+  if (tracker.count >= RATE_LIMIT_MAX) {
+    return false;
+  }
+
+  tracker.count++;
+  return true;
+}
+
+// å®šæœŸçš„ã«å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
+setInterval(() => {
+  const now = Date.now();
+  for (const [key, value] of rateLimitTracker.entries()) {
+    if (now > value.resetTime) {
+      rateLimitTracker.delete(key);
+    }
+  }
+}, 60000);
+
+// ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•° ã“ã“ã¾ã§ =====
+
 // ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•æ™‚é–“ã‚’è¨˜éŒ²
 const SERVER_START_TIME = new Date();
 const SERVER_VERSION = '1.0.1';
@@ -107,20 +191,49 @@ export async function registerRoutes(app: Express): Promise<Server> {
 
   const httpServer = createServer(app);
   
+  // è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆ
+  const ALLOWED_ORIGINS = process.env.ALLOWED_ORIGINS
+    ? process.env.ALLOWED_ORIGINS.split(',')
+    : ['http://localhost:5000', 'http://localhost:3000', 'http://127.0.0.1:5000'];
+
   const io = new SocketIOServer(httpServer, {
     cors: {
-      origin: "*",
-      methods: ["GET", "POST"]
-    }
+      origin: (origin, callback) => {
+        // ã‚ªãƒªã‚¸ãƒ³ãŒãªã„å ´åˆï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ï¼‰ã¾ãŸã¯è¨±å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å ´åˆã¯è¨±å¯
+        if (!origin || ALLOWED_ORIGINS.includes(origin)) {
+          callback(null, true);
+        } else {
+          log(`Blocked CORS request from: ${origin}`);
+          callback(new Error('Not allowed by CORS'));
+        }
+      },
+      methods: ["GET", "POST"],
+      credentials: true
+    },
+    // æ¥ç¶šæ•°åˆ¶é™
+    maxHttpBufferSize: 1e6, // 1MB
+    pingTimeout: 20000,
+    pingInterval: 25000
   });
 
   io.on("connection", (socket) => {
     log(`New client connected: ${socket.id}`);
-    
-    socket.on("user:join", (username: string) => {
-      log(`User joined: ${username} (${socket.id})`);
-      
-      socket.data.username = username;
+
+    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ç”¨ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
+    socket.use((packet, next) => {
+      if (!checkRateLimit(socket.id)) {
+        log(`Rate limit exceeded for socket: ${socket.id}`);
+        next(new Error('Rate limit exceeded'));
+        return;
+      }
+      next();
+    });
+
+    socket.on("user:join", (username: unknown) => {
+      const validUsername = validateUsername(username);
+      log(`User joined: ${validUsername} (${socket.id})`);
+
+      socket.data.username = validUsername;
     });
     
     socket.on("room:create", () => {
@@ -163,13 +276,19 @@ export async function registerRoutes(app: Express): Promise<Server> {
       }
     });
     
-    socket.on("room:join", (roomId: string) => {
+    socket.on("room:join", (roomIdInput: unknown) => {
+      const roomId = validateRoomId(roomIdInput);
+      if (!roomId) {
+        socket.emit("error", { message: "Invalid room ID format" });
+        return;
+      }
+
       log(`Received room:join request for roomId: ${roomId}`);
       log(`Current gameRooms: ${JSON.stringify(Object.keys(gameRooms))}`);
       const room = gameRooms[roomId];
       log(`Found room? ${!!room}`);
 
-      const username = socket.data.username || "Anonymous";
+      const username = validateUsername(socket.data.username);
       
       if (!room) {
         log(`Room ${roomId} not found.`);
@@ -232,10 +351,17 @@ export async function registerRoutes(app: Express): Promise<Server> {
       }
     });
     
-    socket.on("player:ready", (roomId: string) => {
+    socket.on("player:ready", (roomIdInput: unknown) => {
+      const roomId = validateRoomId(roomIdInput);
+      if (!roomId) {
+        socket.emit("error", { message: "Invalid room ID" });
+        return;
+      }
+
       const room = gameRooms[roomId];
-      
+
       if (!room || !room.players[socket.id]) {
+        socket.emit("error", { message: "Room not found or you are not in this room" });
         return;
       }
       
@@ -282,8 +408,36 @@ export async function registerRoutes(app: Express): Promise<Server> {
       }
     });
     
-    socket.on("game:move", (data: { roomId: string, position: Position, piece: PieceType }) => {
-      const { roomId, position, piece } = data;
+    socket.on("game:move", (data: unknown) => {
+      // ãƒ‡ãƒ¼ã‚¿ã®å‹ãƒã‚§ãƒƒã‚¯
+      if (!data || typeof data !== 'object') {
+        socket.emit("error", { message: "Invalid move data" });
+        return;
+      }
+
+      const moveData = data as { roomId?: unknown; position?: unknown; piece?: unknown };
+
+      // roomId ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
+      const roomId = validateRoomId(moveData.roomId);
+      if (!roomId) {
+        socket.emit("error", { message: "Invalid room ID" });
+        return;
+      }
+
+      // position ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
+      const position = validatePosition(moveData.position);
+      if (!position) {
+        socket.emit("error", { message: "Invalid position" });
+        return;
+      }
+
+      // piece ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
+      const piece = validatePieceType(moveData.piece);
+      if (!piece) {
+        socket.emit("error", { message: "Invalid piece type" });
+        return;
+      }
+
       const room = gameRooms[roomId];
       
       if (!room) {
@@ -389,7 +543,13 @@ export async function registerRoutes(app: Express): Promise<Server> {
       log(`Game state updated for room ${roomId}. Turn: ${gameState.currentPlayer}`);
     });
     
-    socket.on("game:request_rematch", (roomId: string) => {
+    socket.on("game:request_rematch", (roomIdInput: unknown) => {
+      const roomId = validateRoomId(roomIdInput);
+      if (!roomId) {
+        socket.emit("error", { message: "Invalid room ID" });
+        return;
+      }
+
       const room = gameRooms[roomId];
       const playerSocketId = socket.id;
 
@@ -437,7 +597,13 @@ export async function registerRoutes(app: Express): Promise<Server> {
       });
     });
     
-    socket.on("room:leave", (roomId: string) => {
+    socket.on("room:leave", (roomIdInput: unknown) => {
+      const roomId = validateRoomId(roomIdInput);
+      if (!roomId) {
+        socket.emit("error", { message: "Invalid room ID" });
+        return;
+      }
+
       const room = gameRooms[roomId];
       const playerSocketId = socket.id;
 
diff --git a/tsconfig.json b/tsconfig.json
index 12fa45f..1cfaf5d 100644
--- a/tsconfig.json
+++ b/tsconfig.json
@@ -1,13 +1,14 @@
 {
   "include": ["client/src/**/*", "shared/**/*", "server/**/*"],
-  "exclude": ["node_modules", "build", "dist", "**/*.test.ts"],
+  "exclude": ["node_modules", "build", "dist", "**/*.test.ts", "client/src/service-worker.ts"],
   "compilerOptions": {
     "incremental": true,
     "tsBuildInfoFile": "./node_modules/typescript/tsbuildinfo",
     "noEmit": true,
+    "target": "ES2020",
     "module": "ESNext",
     "strict": true,
-    "lib": ["esnext", "dom", "dom.iterable"],
+    "lib": ["ES2020", "dom", "dom.iterable", "webworker"],
     "jsx": "preserve",
     "esModuleInterop": true,
     "skipLibCheck": true,
@@ -19,6 +20,7 @@
       "@/*": ["./client/src/*"],
       "@shared/*": ["./shared/*"]
     },
-    "noImplicitAny": false
+    "noImplicitAny": false,
+    "downlevelIteration": true
   }
 }
diff --git a/vercel.json b/vercel.json
new file mode 100644
index 0000000..9f3fc91
--- /dev/null
+++ b/vercel.json
@@ -0,0 +1,21 @@
+{
+  "buildCommand": "npm run build",
+  "outputDirectory": "dist/client",
+  "framework": "vite",
+  "rewrites": [
+    {
+      "source": "/(.*)",
+      "destination": "/index.html"
+    }
+  ],
+  "headers": [
+    {
+      "source": "/(.*)",
+      "headers": [
+        { "key": "X-Content-Type-Options", "value": "nosniff" },
+        { "key": "X-Frame-Options", "value": "SAMEORIGIN" },
+        { "key": "X-XSS-Protection", "value": "1; mode=block" }
+      ]
+    }
+  ]
+}
-- 
2.51.0.windows.2

